/*! rasterizeHTML.js - v1.2.4 - 2017-11-02
* http://www.github.com/cburgmer/rasterizeHTML.js
* Copyright (c) 2017 Christoph Burgmer; Licensed MIT */

!function(e,t){"function"==typeof define&&define.amd?define(["url","xmlserializer","sane-domparser-error","inlineresources"],function(n,r,o,i){return e.rasterizeHTML=t(n,r,o,i)}):"object"==typeof module&&module.exports?module.exports=t(require("url"),require("xmlserializer"),require("sane-domparser-error"),require("inlineresources")):e.rasterizeHTML=t(e.url,e.xmlserializer,e.sanedomparsererror,e.inlineresources)}(this,function(e,t,n,r){var o=function(e){"use strict";var t={},n=[];t.joinUrl=function(t,n){return t?e.resolve(t,n):n},t.getConstantUniqueIdFor=function(e){return n.indexOf(e)<0&&n.push(e),n.indexOf(e)},t.clone=function(e){var t,n={};for(t in e)e.hasOwnProperty(t)&&(n[t]=e[t]);return n};var r=function(e){return"object"==typeof e&&null!==e},o=function(e){return r(e)&&Object.prototype.toString.apply(e).match(/\[object (Canvas|HTMLCanvasElement)\]/i)};return t.parseOptionalParameters=function(e){var n={canvas:null,options:{}};return null==e[0]||o(e[0])?(n.canvas=e[0]||null,n.options=t.clone(e[1])):n.options=t.clone(e[0]),n},t}(e),i=function(e){"use strict";var t={},n=function(e,t,n){var r=e[t];return e[t]=function(){var e=Array.prototype.slice.call(arguments);return n.apply(this,[e,r])},r};return t.baseUrlRespectingXhr=function(t,r){return function(){var o=new t;return n(o,"open",function(t,n){var o=t.shift(),i=t.shift(),u=e.joinUrl(r,i);return n.apply(this,[o,u].concat(t))}),o}},t.finishNotifyingXhr=function(e){var t,r=0,o=0,i=!1,u=new Promise(function(e){t=function(){r-o<=0&&i&&e({totalCount:r})}}),c=function(){var i=new e;return n(i,"send",function(e,t){return r+=1,t.apply(this,arguments)}),i.addEventListener("load",function(){o+=1,t()}),i};return c.waitForRequestsToFinish=function(){return i=!0,t(),u},c},t}(o),u=function(e){"use strict";var t={},n=function(e){return Array.prototype.slice.call(e)},r={active:!0,hover:!0,focus:!1,target:!1};return t.fakeUserAction=function(t,n,o){var i=t.querySelector(n),u=":"+o,c="rasterizehtml"+o;i&&(r[o]?e.addClassNameRecursively(i,c):e.addClassName(i,c),e.rewriteCssSelectorWith(t,u,"."+c))},t.persistInputValues=function(e){var t=e.querySelectorAll("input"),r=e.querySelectorAll("textarea"),o=function(e){return"checkbox"===e.type||"radio"===e.type};n(t).filter(o).forEach(function(e){e.checked?e.setAttribute("checked",""):e.removeAttribute("checked")}),n(t).filter(function(e){return!o(e)}).forEach(function(e){e.setAttribute("value",e.value)}),n(r).forEach(function(e){e.textContent=e.value})},t.rewriteTagNameSelectorsToLowerCase=function(t){e.lowercaseCssTypeSelectors(t,e.findHtmlOnlyNodeNames(t))},t}(function(){"use strict";var e={},t=function(e){return Array.prototype.slice.call(e)};e.addClassName=function(e,t){e.className+=" "+t},e.addClassNameRecursively=function(t,n){e.addClassName(t,n),t.parentNode!==t.ownerDocument&&e.addClassNameRecursively(t.parentNode,n)};var n=function(e,n){var r=e.parentStyleSheet,o=t(r.cssRules).indexOf(e);r.insertRule(n,o+1),r.deleteRule(o)},r=function(e,t){var r=e.cssText.replace(/^[^\{]+/,"");n(e,t+" "+r)},o=function(e){return t(e).reduce(function(e,t){return e+t.cssText},"")},i=function(e){e.textContent=o(e.sheet.cssRules)},u=function(e){var t=document.implementation.createHTMLDocument(""),n=document.createElement("style");n.textContent=e.textContent,t.body.appendChild(n),e.sheet=n.sheet},c=function(e){return"((?:^|[^.#:\\w])|(?=\\W))("+e.join("|")+")(?=\\W|$)"},a=function(e,n,o){var a=c(n);t(e.querySelectorAll("style")).forEach(function(e){void 0===e.sheet&&u(e);var n=t(e.sheet.cssRules).filter(function(e){return e.selectorText&&new RegExp(a,"i").test(e.selectorText)});n.length&&(n.forEach(function(e){var t=e.selectorText.replace(new RegExp(a,"gi"),function(e,t,n){return t+o(n)});t!==e.selectorText&&r(e,t)}),i(e))})};return e.rewriteCssSelectorWith=function(e,t,n){a(e,[t],function(){return n})},e.lowercaseCssTypeSelectors=function(e,t){a(e,t,function(e){return e.toLowerCase()})},e.findHtmlOnlyNodeNames=function(e){var t,n=e.ownerDocument.createTreeWalker(e,NodeFilter.SHOW_ELEMENT),r={},o={};do{t=n.currentNode.tagName.toLowerCase(),"http://www.w3.org/1999/xhtml"===n.currentNode.namespaceURI?r[t]=!0:o[t]=!0}while(n.nextNode());return Object.keys(r).filter(function(e){return!o[e]})},e}()),c=function(e,t,n,r){"use strict";var o={},i=function(e,t,n,r){var o=e.createElement(t);return o.style.visibility="hidden",o.style.width=n+"px",o.style.height=r+"px",o.style.position="absolute",o.style.top=-1e4-r+"px",o.style.left=-1e4-n+"px",e.getElementsByTagName("body")[0].appendChild(o),o},u=function(e){return e>0?new Promise(function(t){setTimeout(t,e)}):Promise.resolve()};o.executeJavascript=function(e,n){return new Promise(function(o){var c=i(r.document,"iframe",n.width,n.height),a=e.outerHTML,s=[],l=n.executeJsTimeout||0,f=function(){var e=c.contentDocument;r.document.getElementsByTagName("body")[0].removeChild(c),o({document:e,errors:s})},m=c.contentWindow.XMLHttpRequest,d=t.finishNotifyingXhr(m),h=t.baseUrlRespectingXhr(d,n.baseUrl);c.onload=function(){u(l).then(d.waitForRequestsToFinish).then(f)},c.contentDocument.open(),c.contentWindow.XMLHttpRequest=h,c.contentWindow.onerror=function(e){s.push({resourceType:"scriptExecution",msg:e})},c.contentDocument.write("<!DOCTYPE html>"),c.contentDocument.write(a),c.contentDocument.close()})};var c=function(e,t,n){var r=e.createElement("iframe");return r.style.width=t+"px",r.style.height=n+"px",r.style.visibility="hidden",r.style.position="absolute",r.style.top=-1e4-n+"px",r.style.left=-1e4-t+"px",r.style.borderWidth=0,r.sandbox="allow-same-origin",r.scrolling="no",r},a=function(e,t,n){var o=Math.floor(e/n),i=Math.floor(t/n);return c(r.document,o,i)},s=function(e,t,n,r){return{width:Math.max(e.width*r,t),height:Math.max(e.height*r,n)}},l=function(e,t){var n=e.querySelector(t);if(n)return n;if(e.ownerDocument.querySelector(t)===e)return e;throw{message:"Clipping selector not found"}},f=function(e,t,n,o,i){var u,c,a,f,m,d,h,p=Math.max(e.scrollWidth,e.clientWidth),v=Math.max(e.scrollHeight,e.clientHeight);return t?(u=(d=l(e,t).getBoundingClientRect()).top,c=d.left,a=d.width,f=d.height):(u=0,c=0,a=p,f=v),h=s({width:a,height:f},n,o,i),m=r.getComputedStyle(e.ownerDocument.documentElement).fontSize,{left:c,top:u,width:h.width,height:h.height,viewportWidth:p,viewportHeight:v,rootFontSize:m}},m=function(e,t){var n=e.tagName;return t.querySelector(n)},d=function(e){var t=e.tagName.toLowerCase();return"html"===t||"body"===t?e.outerHTML:'<body style="margin: 0;">'+e.outerHTML+"</body>"};o.calculateDocumentContentSize=function(e,t){return new Promise(function(n,o){var i,u=t.zoom||1;i=a(t.width,t.height,u),r.document.getElementsByTagName("body")[0].appendChild(i),i.onload=function(){var c,a=i.contentDocument;try{c=f(m(e,a),t.clip,t.width,t.height,u),n(c)}catch(e){o(e)}finally{r.document.getElementsByTagName("body")[0].removeChild(i)}},i.contentDocument.open(),i.contentDocument.write("<!DOCTYPE html>"),i.contentDocument.write(d(e)),i.contentDocument.close()})},o.parseHtmlFragment=function(e){var t=r.document.implementation.createHTMLDocument("");t.documentElement.innerHTML=e;var n=t.querySelector("body").firstChild;if(!n)throw"Invalid source";return n};var h=function(e,t){var n,o,i,u,c=/<html((?:\s+[^>]*)?)>/im.exec(t),a=r.document.implementation.createHTMLDocument("");if(c)for(n="<div"+c[1]+"></div>",a.documentElement.innerHTML=n,i=a.querySelector("div"),o=0;o<i.attributes.length;o++)u=i.attributes[o],e.documentElement.setAttribute(u.name,u.value)};o.parseHTML=function(e){var t=r.document.implementation.createHTMLDocument("");return t.documentElement.innerHTML=e,h(t,e),t};var p=function(e){try{return n.failOnParseError(e)}catch(e){throw{message:"Invalid source",originalError:e}}};o.validateXHTML=function(e){var t=(new DOMParser).parseFromString(e,"application/xml");p(t)};var v=null,g=function(e,t){return"none"===t||"repeated"===t?(null!==v&&"repeated"===t||(v=Date.now()),e+"?_="+v):e},w=function(t,n){return new Promise(function(r,o){var i=new window.XMLHttpRequest,u=e.joinUrl(n.baseUrl,t),c=g(u,n.cache),a=function(e){o({message:"Unable to load page",originalError:e})};i.addEventListener("load",function(){200===i.status||0===i.status?r(i.responseXML):a(i.statusText)},!1),i.addEventListener("error",function(e){a(e)},!1);try{i.open("GET",c,!0),i.responseType="document",i.send(null)}catch(e){a(e)}})};return o.loadDocument=function(e,t){return w(e,t).then(function(e){return p(e)})},o}(o,i,n,window),a=function(e){"use strict";var t,n={},r=function(e,t){return t?URL.createObjectURL(new Blob([e],{type:"image/svg+xml"})):"data:image/svg+xml;charset=utf-8,"+encodeURIComponent(e)},o=function(e){e instanceof Blob&&URL.revokeObjectURL(e)},i='<svg xmlns="http://www.w3.org/2000/svg" width="1" height="1"><foreignObject></foreignObject></svg>',u=function(e){return new Promise(function(t,n){var r=document.createElement("canvas"),o=new Image;o.onload=function(){var e=r.getContext("2d");try{e.drawImage(o,0,0),r.toDataURL("image/png"),t(!0)}catch(e){t(!1)}},o.onerror=n,o.src=e})},c=function(){var e=r(i,!0);return u(e).then(function(t){return o(e),!t&&u(r(i,!1)).then(function(e){return e})},function(){return!1})},a=function(){if(e.Blob)try{return new Blob(["<b></b>"],{type:"text/xml"}),!0}catch(e){}return!1},s=function(){return new Promise(function(t,n){a()&&e.URL?c().then(function(e){t(!e)},function(){n()}):t(!1)})},l=function(){return void 0===t&&(t=s()),t},f=function(e){return l().then(function(t){return r(e,t)})};return n.renderSvg=function(e){return new Promise(function(t,n){var r,i,u=function(){i.onload=null,i.onerror=null},c=function(){r&&o(r)};(i=new Image).onload=function(){u(),c(),t(i)},i.onerror=function(){c(),n()},f(e).then(function(e){r=e,i.src=r},n)})},n}(window);return function(e,t,n){"use strict";var r={},o=function(e,t){var n=e?e.width:300,r=e?e.height:200;return{width:void 0!==t.width?t.width:n,height:void 0!==t.height?t.height:r}},i=function(t){var n,r=o(t.canvas,t.options);return n=e.clone(t.options),n.width=r.width,n.height=r.height,n};r.drawDocument=function(){var t=arguments[0],r=Array.prototype.slice.call(arguments,1),o=e.parseOptionalParameters(r),u=t.documentElement?t.documentElement:t;return n.rasterize(u,o.canvas,i(o))};var u=function(e,n,o){var i=t.parseHTML(e);return r.drawDocument(i,n,o)};r.drawHTML=function(){var t=arguments[0],n=Array.prototype.slice.call(arguments,1),r=e.parseOptionalParameters(n);return u(t,r.canvas,r.options)};var c=function(t,n,r){var o=document.implementation.createHTMLDocument("");o.replaceChild(t.documentElement,o.documentElement);var i=r?e.clone(r):{};return r.baseUrl||(i.baseUrl=n),{document:o,options:i}},a=function(e,n,o){return t.loadDocument(e,o).then(function(t){var i=c(t,e,o);return r.drawDocument(i.document,n,i.options)})};return r.drawURL=function(){var t=arguments[0],n=Array.prototype.slice.call(arguments,1),r=e.parseOptionalParameters(n);return a(t,r.canvas,r.options)},r}(o,c,function(e,t,n,r,o,i){"use strict";var u={},c=function(e){return{message:"Error rendering page",originalError:e}},a=function(e){return o.renderSvg(e).then(function(t){return{image:t,svg:e}},function(e){throw c(e)})},s=function(e,t){try{t.getContext("2d").drawImage(e,0,0)}catch(e){throw c(e)}},l=function(e,t,n){return r.drawDocumentAsSvg(e,n).then(a).then(function(e){return t&&s(e.image,t),e})},f=function(e,r){return t.executeJavascript(e,r).then(function(e){var t=e.document;return n.persistInputValues(t),{document:t,errors:e.errors}})};return u.rasterize=function(t,n,r){var o;return o=e.clone(r),o.inlineScripts=!0===r.executeJs,i.inlineReferences(t,o).then(function(e){return r.executeJs?f(t,r).then(function(t){return{element:t.document.documentElement,errors:e.concat(t.errors)}}):{element:t,errors:e}}).then(function(e){return l(e.element,n,r).then(function(t){return{image:t.image,svg:t.svg,errors:e.errors}})})},u}(o,c,u,function(e,t,n,r){"use strict";var o={},i=function(e,t){var n=t||1,r={width:e.width,height:e.height,"font-size":e.rootFontSize};return 1!==n&&(r.style="transform:scale("+n+"); transform-origin: 0 0;"),r},u=function(e){var t,n;return t=Math.round(e.viewportWidth),n=Math.round(e.viewportHeight),{x:-e.left,y:-e.top,width:t,height:n}},c=function(e){var t=e.style||"";e.style=t+"float: left;"},a=function(e){e.externalResourcesRequired=!0},s=function(e){var t=Object.keys(e);return t.length?" "+t.map(function(t){return t+'="'+e[t]+'"'}).join(" "):""},l=function(e,n,o){var l=r.serializeToString(e);t.validateXHTML(l);var f=u(n);return c(f),a(f),'<svg xmlns="http://www.w3.org/2000/svg"'+s(i(n,o))+'><style scoped="">html::-webkit-scrollbar { display: none; }</style><foreignObject'+s(f)+">"+l+"</foreignObject></svg>"};return o.getSvgForDocument=function(e,t,r){return n.rewriteTagNameSelectorsToLowerCase(e),l(e,t,r)},o.drawDocumentAsSvg=function(e,r){return["hover","active","focus","target"].forEach(function(t){r[t]&&n.fakeUserAction(e,r[t],t)}),t.calculateDocumentContentSize(e,r).then(function(t){return o.getSvgForDocument(e,t,r.zoom)})},o}(0,c,u,t),a,r))});